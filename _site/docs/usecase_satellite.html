<p>import useBaseUrl from ‘@docusaurus/useBaseUrl’;</p>

<h2 id="about">About</h2>

<p>This use case describes how to get the satellite field images and display them on <a href="https://leafletjs.com/">Leaflet JS</a>.</p>

<h3 id="register">Register</h3>

<p>To register with Leaf:</p>

<ul>
  <li>Go to <a href="https://withleaf.io/registration/">registration link</a> and create your account.</li>
  <li>Save your credentials to use in the next steps.</li>
</ul>

<h2 id="backend">Backend</h2>

<h3 id="create-server">Create server</h3>

<p>After registered, you will need to setup a server, in this case we will use the Express Framework to create the server and the Axios library to do POST/GET requests in our server:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">axios</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">axios</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>Now you will need to define some routes that your server will use, in this example, we define the follow routes:</p>

<h3 id="routes">Routes</h3>

<h4 id="route-create_token">Route ‘/create_token’</h4>

<p>In this route, we will create the user token to use in the next steps. In the <code class="language-plaintext highlighter-rouge">data</code> object,
we need the attributes <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> that comes from a form in the front-end,
and the attribute <code class="language-plaintext highlighter-rouge">rememberMe</code> is optional.
We make a POST request with AXIOS to the Leaf API endpoint that is responsible to create our token,
if everything is ok, it will return an status code <code class="language-plaintext highlighter-rouge">200</code>, and the token will be returned to the user,
if anything is wrong, it will be catched by the <code class="language-plaintext highlighter-rouge">.catch()</code> function.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/create_token</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Comes from the frontend form</span>
  <span class="kd">let</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">passwd</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>

  <span class="c1">// Leaf API endpoint</span>
  <span class="kd">let</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://api.withleaf.io/api/authenticate</span><span class="dl">"</span><span class="p">;</span>

  <span class="c1">// Data to post to endpoint</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="nx">passwd</span><span class="p">,</span>
    <span class="na">rememberMe</span><span class="p">:</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span>
  <span class="p">};</span>

  <span class="nx">axios</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Save the token in the token variable</span>
      <span class="nx">token</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">id_token</span><span class="dl">"</span><span class="p">];</span>
      <span class="c1">// Return ok and the token to the frontend request</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Congrats! Login done!</span><span class="dl">"</span><span class="p">,</span> <span class="na">token</span><span class="p">:</span> <span class="nx">token</span> <span class="p">});</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If something wrong happens, returns login failed.</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Oops! Login failed!</span><span class="dl">"</span><span class="p">,</span> <span class="na">token</span><span class="p">:</span> <span class="dl">""</span> <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If the credentials are wrong, returns that.</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Oops! Invalid credentials!</span><span class="dl">"</span><span class="p">,</span> <span class="na">token</span><span class="p">:</span> <span class="dl">""</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p><a href="//authentication">Here</a> you can see the Authentication documentation.</p>

<h4 id="route-monitored_fields">Route ‘/monitored_fields’</h4>

<p>In this route, we will be able to retrieve all our satellite monitored fields. First we verify if the front-end request is sending a token in the Authorization header, if yes, we do a <code class="language-plaintext highlighter-rouge">GET</code> request with AXIOS to the Leaf API endpoint responsible to give us that information and then we return it to the frontend.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/monitored_fields</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">authorization</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid token, generate one first!</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">authorization</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://api.withleaf.io/services/satellite/api/fields</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="s2">`Bearer `</span> <span class="o">+</span> <span class="nx">token</span> <span class="p">};</span>

    <span class="nx">axios</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="p">{</span> <span class="nx">headers</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">Something wrong happend during the request!</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="route-field_images">Route ‘/field_images’</h4>

<p>In this route, we will retrieve all the images from one satellite monitored field. In the first step, we will do a <code class="language-plaintext highlighter-rouge">GET</code> request with AXIOS to the Leaf API endpoint that will return to us the information about the field selected, with this endpoint, we can get the field coordinates and send to the frontend, so we can plot the images in the right point of the map. In the second step, we will do a <code class="language-plaintext highlighter-rouge">GET</code> request with AXIOS to the Leaf API endpoint that is responsible to return the images about the field selected, after receiving the images, we will sort them by the date, and we will save in another array just the images that are of the type <code class="language-plaintext highlighter-rouge">NDVI_RELATIVE</code> or <code class="language-plaintext highlighter-rouge">RGB</code>, that are the ones we are interested now.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/field_images</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">authorization</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid token, generate one first!</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// This comes from the frontend form.</span>
    <span class="kd">let</span> <span class="nx">field_id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">startDate</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">startDate</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">endDate</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">endDate</span><span class="p">;</span>

    <span class="kd">let</span> <span class="nx">endpoint</span> <span class="o">=</span>
      <span class="dl">"</span><span class="s2">https://api.withleaf.io/services/satellite/api/fields/</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">field_id</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="s2">`Bearer `</span> <span class="o">+</span> <span class="nx">token</span> <span class="p">};</span>

    <span class="kd">let</span> <span class="nx">field_geometry</span><span class="p">;</span>

    <span class="c1">// First step</span>
    <span class="nx">axios</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="p">{</span> <span class="nx">headers</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">No images were found for the time and field selected</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// Get the field coordinates</span>
          <span class="nx">field_geometry</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">;</span>

          <span class="nx">endpoint</span> <span class="o">=</span>
            <span class="dl">"</span><span class="s2">https://api.withleaf.io/services/satellite/api</span><span class="dl">"</span> <span class="o">+</span>
            <span class="dl">"</span><span class="s2">/fields/</span><span class="dl">"</span> <span class="o">+</span>
            <span class="nx">field_id</span> <span class="o">+</span>
            <span class="dl">"</span><span class="s2">/processes</span><span class="dl">"</span><span class="p">;</span>

          <span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="na">startDate</span><span class="p">:</span> <span class="nx">startDate</span><span class="p">,</span> <span class="na">endDate</span><span class="p">:</span> <span class="nx">endDate</span> <span class="p">};</span>
          <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="s2">`Bearer `</span> <span class="o">+</span> <span class="nx">token</span> <span class="p">};</span>

          <span class="c1">// Second step</span>
          <span class="nx">axios</span>
            <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="p">{</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">params</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">let</span> <span class="nx">data_obj</span> <span class="o">=</span> <span class="p">[];</span>
              <span class="nx">data_obj</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">data_obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Here we are creating an Date Object with the date string that comes</span>
                <span class="c1">// from the API return, so we can sort the days by the date.</span>
                <span class="nx">data_obj</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                  <span class="nx">e</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">);</span>
                <span class="p">});</span>

                <span class="c1">// Sorting the days by the dates.</span>
                <span class="kd">let</span> <span class="nx">sorted_days</span> <span class="o">=</span> <span class="nx">data_obj</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span>
                  <span class="p">(</span><span class="nx">objA</span><span class="p">,</span> <span class="nx">objB</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">objB</span><span class="p">.</span><span class="nx">date</span><span class="p">)</span> <span class="o">-</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">objA</span><span class="p">.</span><span class="nx">date</span><span class="p">)</span>
                <span class="p">);</span>

                <span class="c1">// This is the variable that we will fill and return in the request.</span>
                <span class="kd">let</span> <span class="nx">providerPNG</span> <span class="o">=</span> <span class="p">[];</span>

                <span class="nx">sorted_days</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                  <span class="c1">// Checking if the clouds coverage of that image is less than 80%.</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clouds</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">day</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="na">id</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                      <span class="na">date</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
                      <span class="na">clouds</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clouds</span><span class="p">,</span>
                      <span class="na">coverage</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">coverage</span><span class="p">,</span>
                      <span class="na">provider</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">provider</span><span class="p">,</span>
                      <span class="na">images</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="p">};</span>
                    <span class="c1">// For each image of each day, we will check if the image is of</span>
                    <span class="c1">// the type 'NDVI_RELATIVE' or 'RGB', if yes, we push it to the</span>
                    <span class="c1">// providerPNG array.</span>
                    <span class="nx">e</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                      <span class="k">if</span> <span class="p">(</span>
                        <span class="nx">f</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">png</span><span class="dl">"</span> <span class="o">&amp;&amp;</span>
                        <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">NDVI_relative.png</span><span class="dl">"</span><span class="p">)</span> <span class="o">||</span>
                          <span class="nx">f</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">RGB.png</span><span class="dl">"</span><span class="p">))</span>
                      <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">day</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
                      <span class="p">}</span>
                    <span class="p">});</span>
                    <span class="nx">providerPNG</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">day</span><span class="p">);</span>
                  <span class="p">}</span>
                <span class="p">});</span>

                <span class="c1">// Checking if the length of providerPNG is greater then 0, if yes,</span>
                <span class="c1">// return the images and the field geometry.</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">providerPNG</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">geometry</span><span class="p">:</span> <span class="nx">field_geometry</span><span class="p">,</span> <span class="na">images</span><span class="p">:</span> <span class="nx">providerPNG</span> <span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
                    <span class="dl">"</span><span class="s2">No images were found for the time and field selected</span><span class="dl">"</span>
                  <span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
                  <span class="dl">"</span><span class="s2">No images were found for the time and field selected</span><span class="dl">"</span>
                <span class="p">);</span>
              <span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p><a href="/docs/crop_monitoring_endpoints#get-images-of-satellite-field">Here</a> you can see the Satellite documentation.</p>

<h4 id="route-create_field">Route ‘/create_field’</h4>

<p>In this route, we will receive data from the frontend and make a <code class="language-plaintext highlighter-rouge">POST</code> request with AXIOS to the Leaf API endpoint responsible for creating satellite monitored fields. Before trying to reach the Leaf API endpoint, we need to verify if the GEOJSON that comes from the frontend is valid, so we will not make irregular post requests to the endpoint.
You can check <a href="https://geojson.org/">here</a> more info about GEOJSON.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/create_field</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">authorization</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">You have to login first!</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// This comes from the frontend form.</span>
    <span class="kd">let</span> <span class="nx">field_name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">field_name</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">boundery_type</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">boundery_type</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">field_boundery</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">field_boundery</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">days_before</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">days_before</span><span class="p">;</span>

    <span class="c1">// A function to try to parse the form geojson data to a object.</span>
    <span class="kd">function</span> <span class="nx">isJsonString</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">field_boundery</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isJsonString</span><span class="p">(</span><span class="nx">field_boundery</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">Error during compiling your geojson, try again with valid data.</span><span class="dl">"</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://api.withleaf.io/services/satellite/api/fields</span><span class="dl">"</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="s2">`Bearer `</span> <span class="o">+</span> <span class="nx">token</span> <span class="p">};</span>

      <span class="c1">// Define the DATA object that we will send in the POST request to</span>
      <span class="c1">// Leaf API endpoint.</span>
      <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">externalId</span><span class="p">:</span> <span class="nx">field_name</span><span class="p">,</span>
        <span class="na">daysBefore</span><span class="p">:</span> <span class="nx">days_before</span><span class="p">,</span>
        <span class="na">providers</span><span class="p">:</span> <span class="p">[],</span>
        <span class="na">geometry</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="nx">boundery_type</span><span class="p">,</span>
          <span class="na">coordinates</span><span class="p">:</span> <span class="p">[</span><span class="nx">field_boundery</span><span class="p">],</span>
        <span class="p">},</span>
      <span class="p">};</span>

      <span class="c1">// Here is the AXIOS post, we will return 'Field created' if everything</span>
      <span class="c1">// was ok with the data and the field was created. If something is wrong</span>
      <span class="c1">// we return the message 'Something wrong happened, verify your data and</span>
      <span class="c1">// try again!'</span>
      <span class="nx">axios</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{</span> <span class="nx">headers</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">Field created</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">Something wrong happened, verify your data and try again!</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p><a href="/docs/crop_monitoring_endpoints#create-a-satellite-field">Here</a> you can see the Satellite documentation.</p>

<h3 id="start-the-server">Start the server</h3>

<p>For the last part, we need to start our server, and make the front-end!</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Server started!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="frontend">Frontend</h2>

<p>In the frontend, we will use the Angular Framework!
It’s important to say that we will use the <a href="https://leafletjs.com/">LeafletJS</a> to display the map and images on it.</p>

<h3 id="creating-the-project">Creating the project</h3>

<p>To create our project, we can use this command from angular <code class="language-plaintext highlighter-rouge">ng new &lt;your app name&gt;</code>. This command will ask some questions about the project and them create all the files and folder structure to our project.</p>

<h3 id="creating-the-component">Creating the component</h3>

<p>After doing this step, we will need to create our <code class="language-plaintext highlighter-rouge">Map Component</code>, to do this you can use also this command from angular: <code class="language-plaintext highlighter-rouge">ng generate component &lt;component-name&gt;</code>, this will generate 3 files for your component: The CSS File for your component, the HTML file, and the TS file, where the logic will be.</p>

<p>In our HTML we will have three simple forms to get the information that we need, and with that information we will proccess and send to our service, that will communicate with our API, e will have one <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> that will contain our map, and our sidebar.</p>

<h3 id="creating-the-service">Creating the service</h3>

<p>To create our service that will communicate with our API, we will use the command <code class="language-plaintext highlighter-rouge">ng generate service &lt;service-name&gt;</code>, this will generate the file responsible.</p>

<p>In the next steps, it will be demonstrated how to do every step until we show the images in the map.</p>

<h3 id="main-functions">Main functions</h3>

<h4 id="initializing-the-forms-and-the-map">Initializing the forms and the map</h4>

<p>This is our function that will be called automatically by angular when the page is started, it initializes the map with the sidebar in the function <code class="language-plaintext highlighter-rouge">initMap()</code> and also initialize the forms that we need. Don’t forget that you need to set the GETTERS and SETTERS for each attribute defined below, so you can retrieve and change the value.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ngOnInit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initMap</span><span class="p">();</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">token</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loginForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormGroup</span><span class="p">({</span>
      <span class="na">email</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">searchImagesForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormGroup</span><span class="p">({</span>
      <span class="na">fieldId</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
      <span class="na">startDate</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
      <span class="na">endDate</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">createFieldForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormGroup</span><span class="p">({</span>
      <span class="na">fieldId</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
      <span class="na">daysBefore</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
      <span class="na">bounderyType</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
      <span class="na">fieldBoundery</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
      <span class="na">provider</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="dl">''</span><span class="p">),</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<h4 id="login">Login</h4>

<p>This function will be called by our button in the form, we need to retrieve the information from the form using the getters and then send it to our service, that will add our token to the header and send to the back-end.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">doLogin</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="c1">// Using the email and password getters:</span>
    <span class="kd">let</span> <span class="nx">email</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getEmail</span><span class="p">().</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">password</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPassword</span><span class="p">().</span><span class="nx">value</span><span class="p">;</span>
    <span class="c1">// You could also do this way:</span>
    <span class="c1">// this.loginForm.get('email')!.value</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">email</span> <span class="o">===</span> <span class="dl">''</span> <span class="o">||</span> <span class="nx">password</span> <span class="o">===</span> <span class="dl">''</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="c1">// You can do some validations here</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Calling a function from our appService, sending the email and password</span>
      <span class="c1">// that will be redirected to the back-end.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">appService</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">loginMessage</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Congrats! Login done!</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Saving our token that the back-end send back to us</span>
          <span class="c1">// for the next steps</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">isLogged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">isLogged</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>In our service, we will define the function login()</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">login</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">post</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">create_token</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="nx">password</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<h4 id="load-satellite-monitored-fields">Load satellite monitored fields</h4>

<p>This function is responsible to reach our backend and give us back the list of the available satellite monitored fields. After receiving them you can show it to the user to choose which one he wants to see images.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">loadCreatedFields</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="c1">// Sending our token that we retrieved in the first step.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">appService</span>
      <span class="p">.</span><span class="nx">loadFields</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">token</span><span class="dl">'</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>In our service, we will define the function loadFields()</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">loadFields</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// Setting our token in the Authorization header so we</span>
    <span class="c1">// can send it to the back-end</span>
    <span class="kd">let</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HttpHeaders</span><span class="p">().</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">monitored_fields</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">headers</span> <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<h4 id="load-the-images-for-a-specific-field">Load the images for a specific field</h4>

<p>This function is reponsible for getting the form information and send to our back-end that will return the satellite images for a specific field. After our backend return to us the list of the images, we need to retrieve the coordinates of that field from the backend response, and also the images. With the geometry, we can create a GEOJSON layer, to display the bounds of the field, and with the images we can plot them in the map.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">loadFieldImages</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">images</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">fieldId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getFieldId</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">startDate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStartDate</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">endDate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getEndDate</span><span class="p">()</span><span class="o">!</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fieldId</span> <span class="o">===</span> <span class="dl">''</span> <span class="o">||</span> <span class="nx">startDate</span> <span class="o">===</span> <span class="dl">''</span> <span class="o">||</span> <span class="nx">endDate</span> <span class="o">===</span> <span class="dl">''</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">loadImagesMessage</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">You need to fill all the inputs.</span><span class="dl">'</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">appService</span>
        <span class="p">.</span><span class="nx">loadImages</span><span class="p">(</span><span class="nx">fieldId</span><span class="p">,</span> <span class="nx">startDate</span><span class="p">,</span> <span class="nx">endDate</span><span class="p">,</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="dl">'</span><span class="s1">token</span><span class="dl">'</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">loadImagesMessage</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span>
            <span class="nx">data</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">No images were found for the time and field selected</span><span class="dl">'</span> <span class="o">||</span>
            <span class="nx">data</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Request failed with status code 404</span><span class="dl">'</span>
          <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Here you can show something to the user if no images were found</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">images</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">loadImagesMessage</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">images</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">images</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">images</span><span class="p">;</span>

            <span class="c1">// Save the field geometry from the response.</span>
            <span class="kd">let</span> <span class="nx">geometry</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

            <span class="c1">// Create a object containing the field coordinates to create a Leaflet Layer.</span>
            <span class="kd">let</span> <span class="nx">json</span> <span class="o">=</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Feature</span><span class="dl">'</span> <span class="k">as</span> <span class="nx">GeoJsonTypes</span><span class="p">,</span>
              <span class="na">geometry</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Polygon</span><span class="dl">'</span><span class="p">,</span>
                <span class="na">coordinates</span><span class="p">:</span> <span class="p">[</span><span class="nx">geometry</span><span class="p">],</span>
              <span class="p">},</span>
            <span class="p">};</span>

            <span class="c1">// Create a object that will define the style of the polygon</span>
            <span class="kd">let</span> <span class="nx">polygonStyle</span> <span class="o">=</span> <span class="p">{</span>
              <span class="na">weight</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="na">opacity</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
              <span class="na">fill</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
              <span class="dl">'</span><span class="s1">fill-opacity</span><span class="dl">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span> <span class="k">as</span> <span class="nx">L</span><span class="p">.</span><span class="nx">GeoJSONOptions</span><span class="p">;</span>

            <span class="c1">// Clear all the bounds created in the bounds group layer</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">clearLayers</span><span class="p">();</span>
            <span class="c1">// Clear all the images created in the imagens group layer</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">imagens</span><span class="p">.</span><span class="nx">clearLayers</span><span class="p">();</span>

            <span class="c1">// Create the geoJson layer of LeafletJS.</span>
            <span class="kd">let</span> <span class="nx">geoJsonLayer</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">geoJson</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">polygonStyle</span><span class="p">).</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">);</span>

            <span class="c1">// Saving the bounds of the field from the geoJsonLayer</span>
            <span class="kd">let</span> <span class="nx">geoBounds</span> <span class="o">=</span> <span class="nx">geoJsonLayer</span><span class="p">.</span><span class="nx">getBounds</span><span class="p">();</span>

            <span class="c1">// Make the map fly to the right coordintes of the field.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">flyTo</span><span class="p">(</span><span class="nx">geoJsonLayer</span><span class="p">.</span><span class="nx">getBounds</span><span class="p">().</span><span class="nx">getCenter</span><span class="p">(),</span> <span class="mi">15</span><span class="p">);</span>

            <span class="c1">// Checking if are any avaiable images and for each image</span>
            <span class="c1">// save the url of the image and the bound of the field in</span>
            <span class="c1">// the images array</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="na">e</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="nx">e</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="na">f</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="nx">geoBounds</span><span class="p">;</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">provider</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">sentinel</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">f</span><span class="p">.</span><span class="nx">imgtype</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/0/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">provider</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">planet</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">f</span><span class="p">.</span><span class="nx">imgtype</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">url</span>
                    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">_SR.tif/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">f</span><span class="p">.</span><span class="nx">imgtype</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">not supported</span><span class="dl">'</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">});</span>
              <span class="nx">e</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>In our service, we will define the function loadImages()</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">loadImages</span><span class="p">(</span><span class="nx">fieldId</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">startDate</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">endDate</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">token</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HttpHeaders</span><span class="p">().</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">post</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">field_images</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="nx">fieldId</span><span class="p">,</span>
        <span class="na">startDate</span><span class="p">:</span> <span class="nx">startDate</span><span class="p">,</span>
        <span class="na">endDate</span><span class="p">:</span> <span class="nx">endDate</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="nx">headers</span> <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<h4 id="show-and-hide-map-layers">Show and hide map layers</h4>

<p>With this function, we will receive an url from the parameter when the user clicks in the image he wants to see, and then we will display that image.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">showImage</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Clear all the images from the imagens group layer, so only one</span>
  <span class="c1">// image will be displayed.</span>
  <span class="nx">imagens</span><span class="p">.</span><span class="nx">clearLayers</span><span class="p">();</span>

  <span class="c1">// If you remember, in the images array, we saved all the</span>
  <span class="c1">// images url, and the bounds of the fields. So when we receive</span>
  <span class="c1">// one url in the parameter, we will search the url in the array</span>
  <span class="c1">// and if it is a valid url, we will retrieve the bounds and then</span>
  <span class="c1">// display the image in the map.</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="na">f</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">L</span><span class="p">.</span><span class="nx">imageOverlay</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">bounds</span><span class="p">).</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">imagens</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="extra">Extra</h3>

<p>In this case, we are using the LeafletJS library, so we need to create our map, and add the base layers we want. We will add a layer for the <a href="https://www.openstreetmap.org/">OpenStreetMap</a> basemap, and one for the <a href="https://www.mapbox.com/">Mapbox</a> basemap. To use the MapBox basemap without creating an map variable to it, we need to setup our MapBox token in one variable and then reach the mapbox url passing our token.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">private</span> <span class="nx">initMap</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// Create the Map variable.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="dl">'</span><span class="s1">map</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">center</span><span class="p">:</span> <span class="p">[</span><span class="mf">39.8282</span><span class="p">,</span> <span class="o">-</span><span class="mf">98.5795</span><span class="p">],</span>
      <span class="na">zoom</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1">// OpenStreetMap Layer.</span>
    <span class="kd">const</span> <span class="nx">osm</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span>
      <span class="dl">'</span><span class="s1">https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="na">maxZoom</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="na">minZoom</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="na">attribution</span><span class="p">:</span>
          <span class="dl">'</span><span class="s1">&amp;copy; &lt;a href="http://www.openstreetmap.org/copyright"&gt;OpenStreetMap&lt;/a&gt;</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">);</span>

    <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">YOUR MAPBOX TOKEN</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">// MapBox Layer.</span>
    <span class="kd">const</span> <span class="nx">mapBox</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span>
      <span class="dl">'</span><span class="s1">https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=</span><span class="dl">'</span> <span class="o">+</span>
        <span class="nx">token</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="na">maxZoom</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
        <span class="na">tileSize</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
        <span class="na">zoomOffset</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="na">attribution</span><span class="p">:</span>
          <span class="dl">'</span><span class="s1">© &lt;a href="https://www.mapbox.com/contribute/"&gt;Mapbox&lt;/a&gt; © &lt;a href="http://www.openstreetmap.org/copyright"&gt;OpenStreetMap&lt;/a&gt;</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">);</span>

    <span class="nx">osm</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>
    <span class="nx">mapBox</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>

    <span class="c1">// The base maps.</span>
    <span class="kd">const</span> <span class="nx">baseMaps</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">OpenStreetMap</span><span class="p">:</span> <span class="nx">osm</span><span class="p">,</span>
      <span class="na">MapBox</span><span class="p">:</span> <span class="nx">mapBox</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c1">//Group layers for the images and the bounds.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">imagens</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">layerGroup</span><span class="p">().</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">layerGroup</span><span class="p">().</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>

    <span class="c1">// Create the base maps control in the map</span>
    <span class="kd">const</span> <span class="nx">layerControl</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">layers</span><span class="p">(</span><span class="nx">baseMaps</span><span class="p">).</span><span class="nx">addTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>

    <span class="c1">// The sidebar options</span>
    <span class="kd">var</span> <span class="na">options</span><span class="p">:</span> <span class="nx">L</span><span class="p">.</span><span class="nx">SidebarOptions</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">container</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sidebar</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">position</span><span class="p">:</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c1">// Creating the sidebar</span>
    <span class="kd">var</span> <span class="nx">sidebar</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">sidebar</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="c1">// Adding the sidebar to the map</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="nx">sidebar</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>See <a href="https://docs.mapbox.com/">here</a> more informations about Mapbox!<br />
See <a href="https://leafletjs.com/">here</a> more informations about LeafletJS!</p>

<p>:::tip
<a href="https://stackblitz.com/edit/node-m3hnvp?file=README.md">Here</a> you can run a live use case demo!
:::</p>
