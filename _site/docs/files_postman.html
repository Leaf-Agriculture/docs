<h2 id="overview">Overview</h2>

<p>Leaf’s Operation Data API returns aggregated, cleaned, and standardized data
from all major machine data brands in a simple JSON response. This tutorial will
walk through how to create a Leaf user, securely authenticate with their chosen
platforms, and receive auto-updating data from all of them with a single request.</p>

<p>We also provide a <a href="https://github.com/Leaf-Agriculture/Leaf-quickstart-Postman-collection">quickstart</a> Postman collection so you can follow
along easily.</p>

<p>To make calls to Leaf’s API, you will need a Leaf account. If you don’t have one
yet, please create your Leaf account and get your token.</p>

<p>You can integrate with many different companies, and you only have to do it once
for each user. To connect, you just choose the company you wish to connect to
and follow these 3 steps:</p>

<ol>
  <li>Get the authentication URL of company you want to connect to</li>
  <li>Get yours and your user’s tokens</li>
  <li>Add credentials to Leaf</li>
</ol>

<p>Now you can opt to connect to more companies or Create a Leaf User and attach
these credentials, so that Leaf can represent your user internally and you can
query specifically for them and their data.</p>

<p><strong>All set!</strong></p>

<p>Leaf automatically detects and starts processing new files. You can access in
“Get Operation Files”.</p>

<h3 id="roadmap">Roadmap</h3>
<p>Today, you can to connect to these companies:</p>

<ul>
  <li>John Deere (<a href="https://medium.com/leaf-agriculture/how-to-use-leafs-api-to-retrieve-machinery-data-from-john-deere-fb1ba331d089">Medium</a>)</li>
  <li>Climate FieldView (<a href="https://medium.com/leaf-agriculture/how-to-use-leafs-api-to-retrieve-machinery-data-from-climate-fieldview-dda921f40291">Medium</a>)</li>
  <li>CNHi</li>
  <li>Trimble</li>
</ul>

<p>Coming in the third quarter of 2020:</p>

<ul>
  <li>Raven</li>
  <li>AGCO</li>
</ul>

<p>Coming in the fourth quarter of 2020:</p>

<ul>
  <li>AgLeader</li>
  <li>Stara</li>
</ul>

<h3 id="john-deere">John Deere</h3>
<p>This section will show you how you can integrate Leaf’s API with you John Deere
account and start using our operations service. Grab our <a href="https://github.com/Leaf-Agriculture/Leaf-quickstart-Postman-collection">quickstart</a>
Postman collection and follow along!</p>

<h4 id="1-get-john-deere-auth-url">1. Get John Deere auth URL</h4>

<p>In Step 1 we will be generating tokens from John Deere. The goal In step 2 is we
will get our John Deere <code class="language-plaintext highlighter-rouge">token_id</code> and <code class="language-plaintext highlighter-rouge">token_secret</code>.</p>

<h5 id="token-verifier">Token Verifier</h5>

<p>In step 1 we will get a temporary “token verifier” from John Deere that confirms
an user’s authentication of your application to access their John Deere data and
generate credentials. We get that verifier by going through their authentication
flow (<a href="https://www.oauth.com/">OAuth2</a>). Before generating the authentication URL, please:</p>

<ul>
  <li>Update current value of <code class="language-plaintext highlighter-rouge">jd_client_key</code> to your app’s client key on John Deere</li>
  <li>Update current value of <code class="language-plaintext highlighter-rouge">jd_client_secret</code> to your app’s client secret on John
Deere</li>
  <li>Update current value of <code class="language-plaintext highlighter-rouge">jd_callback_url</code> to your app’s callback_url on John
Deere</li>
</ul>

<p>Then, to generate the authentication URL your application will send to your user
so they can authorize access to their account files you can use the included
step 2 in the Postman Collection. Change <code class="language-plaintext highlighter-rouge">client_key</code> and <code class="language-plaintext highlighter-rouge">client_ secret</code>
variables to yours received from John Deere when you created an app on your
developer account with them and <code class="language-plaintext highlighter-rouge">redirect_uri</code> to a uri the “token verifier”
will be sent after the user authorizes your application. Hit <em>Send</em>.</p>

<p>Redirect your user to the url included in the response.</p>

<p>They will authenticate and be redirected to the <code class="language-plaintext highlighter-rouge">redirect_url</code>.</p>

<p>Copy the entire url you were redirected to. It looks like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://withleaf.io/?oauth_token=TOKEN&amp;oauth_verifier=CODE
</code></pre></div></div>

<p>Paste it in the environment variable <code class="language-plaintext highlighter-rouge">jd_response_url</code>.</p>

<h4 id="2-get-john-deere-tokens">2. Get John Deere Tokens</h4>

<p>After updating the <code class="language-plaintext highlighter-rouge">jd_response_url</code> in Postman you can submit your credentials
and receive your tokens.</p>

<p>Hit <em>Send</em></p>

<p><code class="language-plaintext highlighter-rouge">token_id</code> and <code class="language-plaintext highlighter-rouge">token_secret_key</code> will be automatically transferred to
<code class="language-plaintext highlighter-rouge">jd_token_id</code> and <code class="language-plaintext highlighter-rouge">jd_token_secret</code> environment variables and will be used in
the next step.</p>

<h4 id="3-add-john-deere-credentials">3. Add John Deere credentials</h4>

<p>Now we can create a Developer-User pair credentials ID that will allow you to
access your user’s John Deere data. We first add the John Deere credentials to
Leaf API.</p>

<p>Hit <em>Send</em></p>

<p>All the info needed has already been filled automatically in Step 2.</p>

<p>An <code class="language-plaintext highlighter-rouge">id</code> for the credentials you just created will be returned. This <code class="language-plaintext highlighter-rouge">id</code> will
be automatically transferred to the value of <code class="language-plaintext highlighter-rouge">jd_credentials_id</code> to be used in
the next step.</p>

<h3 id="climate-field-view">Climate Field View</h3>
<p>Grab our <a href="https://github.com/Leaf-Agriculture/Leaf-quickstart-Postman-collection">quickstart</a> Postman collection and follow along!</p>

<h4 id="1-get-climate-field-view-auth-url">1. Get Climate Field View auth URL</h4>

<p>We will be generating a url to redirect your user to authenticate with Climate.</p>

<p>Update environment variables <code class="language-plaintext highlighter-rouge">cfv_client_id</code> and <code class="language-plaintext highlighter-rouge">cfv_client_secret</code> to your
Climate Field View developer account credentials.</p>

<p>Update environment variable <code class="language-plaintext highlighter-rouge">cfv_redirect_url</code> to your application’s backend</p>

<p>Redirect your user to the script’s output url.</p>

<p>They will authenticate and be redirected to the <code class="language-plaintext highlighter-rouge">redirect_uri</code>.</p>

<p>A code will be sent to that <code class="language-plaintext highlighter-rouge">cfv_redirect_url</code>. We will need this code Step 2.</p>

<p>Copy the code value.</p>

<p>note: this code expires after 1 minute.</p>

<p>Paste code value to environment variable <code class="language-plaintext highlighter-rouge">cfv_code</code></p>

<h4 id="2-get-climate-field-view-tokens">2. Get Climate Field View tokens</h4>

<p>Hit “Send”</p>

<p>A lot of information will be returned. The important ones are <code class="language-plaintext highlighter-rouge">access_token</code>
and <code class="language-plaintext highlighter-rouge">refresh_token</code>. These will be automatically transferred to
<code class="language-plaintext highlighter-rouge">cfv_access_token</code> and <code class="language-plaintext highlighter-rouge">cfv_refresh_token</code> environment variables and will be
used in the next step.</p>

<h4 id="3-add-climate-field-view-credentials">3. Add Climate Field View credentials</h4>

<p>Now we can create a Developer-User pair credentials ID that will allow you to
access your user’s Climate data. We first add the Climate credentials to Leaf
API, to do that: Hit “Send”</p>

<p>An <code class="language-plaintext highlighter-rouge">id</code> for the credentials you just created will be returned. This <code class="language-plaintext highlighter-rouge">id</code> will
be automatically transferred to the value of <code class="language-plaintext highlighter-rouge">cfv_credentials_id</code> to be used in
the next step.</p>

<h3 id="leaf-user">Leaf User</h3>

<h4 id="create-leaf-user">Create Leaf User</h4>

<p>Now we have to attach credentials to a Leaf User. To do so, we can create a
Leaf user and attach our John Deere and/or Climate Field View credentials via
the credentials id. We can also attach credentials from other companies to this
same user to query all available data by Grower/Farm/Field regardless of brand.</p>

<p>Update (optional) fields “address”, “email”, “name” and “phone” with your
user’s information.</p>

<p>We have automatically included our <code class="language-plaintext highlighter-rouge">jd_credentials_id</code> to this call and
attached it to this user.</p>

<p>Hit “Send”</p>

<p>Along with other information returned, there is an “id”. This “id” is the
<code class="language-plaintext highlighter-rouge">leaf_user_id</code> that will be used in the next (final) Step to query and access
files.</p>

<h4 id="update-leaf-user">Update Leaf User</h4>

<p>To update a Leaf User, let’s say to add another provider credentials or change
the user’s address, we can use this PUT request. Since this method overwrites,
remember to send all the user’s information along with the information you want
to add or update. For example, if you want to add John Deere credentials to a
user that already has ClimateFieldView credentials, remember to specify both
credentials ids.</p>

<h4 id="get-specific-leaf-user">Get specific Leaf User</h4>

<p>Get specific Leaf User With this endpoint you can query all information on a
specific Leaf User, such as their address, email, credentials, etc. To do so,
update the value of the environment variable <code class="language-plaintext highlighter-rouge">leaf_user_id</code> to the Leaf User id
you want to query.</p>

<h4 id="gel-all-leaf-users">Gel all Leaf Users</h4>

<p>Get all Leaf Users With this endpoint you can query all information on all your
Leaf Users, such as their address, email, credentials, etc. Just hit ‘send’.</p>

<h3 id="query-operations-by-field">Query Operations by Field</h3>
<p>To query all operations that happened in a specific field (step 2), we first
need to create that field (step 1). Then, Leaf will automatically detect
operations of that field based on the operations’ and on the field’s
coordinates. This process usually takes about 30 minutes.</p>

<h4 id="1-create-field">1. Create Field</h4>

<p>Here we need to specify a leafUserId (that will be the Leaf User owner of that
field), a externalId (that will be the name we give to the field) and the
geojson geometry of the field (location). After creating the field we can query
it (step 2)</p>

<h4 id="2-get-operations-ids-by-field">2. Get operations’ ids by Field</h4>

<p>To query all operations that happened in a specific field, just update the
environment variable <code class="language-plaintext highlighter-rouge">field_external_id</code> to the field id you want to query
files.</p>

<h3 id="merge-operation-files">Merge Operation Files</h3>

<h4 id="1-merge-files">1. Merge files</h4>

<p>Merging files with Leaf is a very simple process. You just have to list, in the
request json body, the ids of the files you want to merge. Make sure the
operations are of the same type (<code class="language-plaintext highlighter-rouge">APPLIED</code> or <code class="language-plaintext highlighter-rouge">HARVESTED</code> or <code class="language-plaintext highlighter-rouge">PLANTED</code>), so the
results are consistent.</p>

<p>After that, just hit “send” and an id for that merged file will be returned.
You can query that file as any other. It will be listed when you query for all
files and can also be queried specifically by its id</p>

<h4 id="2-query--access-specific-file">2. Query &amp; access specific file</h4>

<p>You can query a merged file as any other. It will be listed when you query for
all files and can also be queried specifically by its id. So this request is
the same as seen on “Get Operation Files”. You just have to update the
environment variable “id” to the id of the merged file.</p>

<p>Keep in mind that merging files is processing-heavy and may take about 20
minutes to finish.</p>

